<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/dashboard.css">
    <link rel="stylesheet" href="styles/alertcenter.css">
    <link rel="icon" href="https://i.ibb.co/XCjDk5m/placeholder.png">
    <title>RAPID Alert Center</title>
</head>
<body>
    <div class="container">
        <div class="alertCenterContainer">
            <div class="supplyShortageLayout">
                <div class="supplyShortageTitle">
                    <h2>Supply Shortage</h2>
                </div>
                <div class="supplyShortageContainer">
                    <div class="SupplyLayout">
                        <div class="supplyTitle">
                            <h4>Water Supply</h4>
                        </div>
                        <div class="SupplyContainer">
                            <div class="runningLow">
                                <p>Limited</p>
                                <ul id="water-limited"></ul>
                            </div>
                            <div class="outofStock">
                                <p>Out of Stock</p>
                                <ul id="water-outofstock"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="SupplyLayout">
                        <div class="supplyTitle">
                            <h4>Gas Supply</h4>
                            <ul id="gas-limited"></ul>
                        </div>
                        <div class="SupplyContainer">
                            <div class="runningLow">
                                <p>Limited</p>
                            </div>
                            <div class="outofStock">
                                <p>Out of Stock</p>
                                <ul id="gas-outofstock"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="SupplyLayout">
                        <div class="supplyTitle">
                            <h4>Medical Supply</h4>
                        </div>
                        <div class="SupplyContainer">
                            <div class="runningLow">
                                <p>Limited</p>
                                <ul id="medical-limited"></ul>
                            </div>
                            <div class="outofStock">
                                <p>Out of Stock</p>
                                <ul id="medical-outofstock"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="SupplyLayout">
                        <div class="supplyTitle">
                            <h4>Food Supply</h4>
                        </div>
                        <div class="SupplyContainer">
                            <div class="runningLow">
                                <p>Limited</p>
                                <ul id="food-limited"></ul>
                            </div>
                            <div class="outofStock">
                                <p>Out of Stock</p>
                                <ul id="food-outofstock"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<!-- 
            <div class="roadUpdatesLayout">
                <div class="supplyShortageTitle">
                    <h2>Road Updates</h2>
                </div>
                <div class="roadUpdatesContainer">
                    <div class="roadClosedLayout">
                        <div class="roadTitle">
                            <h4>Road Closed</h4>
                        </div>
                        <div class="roadContainer"></div>
                    </div>
                    <div class="roadReOpenLayout">
                        <div class="roadTitle">
                            <h4>Road Closed</h4>
                        </div>
                        <div class="roadContainer"></div>
                    </div>
                </div>
            </div>
            -->
        </div>
    </div>
    <script>
        async function fetchSupplyShortages() {
            const apiBaseUrl = 'http://localhost:5000';         // Added this on this html page but can be omitted once transferred to dashboard.js
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('No token found. Please log in again.');
                return;
            }

            try {
                const response = await fetch(`${apiBaseUrl}/get-supplies`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                });

                const data = await response.json();
                console.log("API Response:", data); // Debugging line

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch supplies.');
                }

                // Clear existing lists
                ['water', 'gas', 'medical', 'food'].forEach(supplyType => {
                    document.getElementById(`${supplyType}-limited`).innerHTML = '';
                    document.getElementById(`${supplyType}-outofstock`).innerHTML = '';
                });

                // Process the grouped API response
                data.forEach(group => {
                    const supplyType = group._id.toLowerCase(); // e.g., "Water" -> "water"
                    group.supplies.forEach(supply => {
                        const { name, supplyStatus } = supply;

                        const listId =
                            supplyStatus === 'Limited'
                                ? `${supplyType}-limited`
                                : supplyStatus === 'Out Of Stock'
                                    ? `${supplyType}-outofstock`
                                    : null;

                        if (listId) {
                            const list = document.getElementById(listId);
                            const listItem = document.createElement('li');
                            listItem.textContent = name || 'Unnamed Store';
                            list.appendChild(listItem);
                        }
                    });
                });
            } catch (error) {
                console.error('Error fetching supplies:', error);
                alert('An error occurred while fetching supply data.');
            }
        }

        // Trigger the function to populate the data
        fetchSupplyShortages();

    </script>

</body>
</html>
