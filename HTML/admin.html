<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/dashboard.css">
    <link rel="stylesheet" href="styles/admin.css">
    <link rel="icon" href="https://i.ibb.co/XCjDk5m/placeholder.png">
    <title>RAPID Admin View</title>
</head>
<body>
    <div class="container">
        <div class="adminContainer">
            <div class="topContainer">
                <div class="admintitle">
                    <h2>All Supplies</h2>
                </div>
                <div class="sortby">
                    <label for="sortby1">Sort By Type:</label>
                    <select id="sortby1" name="sortby1">
                        <option value="">All Types</option>
                        <option value="watersupply">Water Supply</option>
                        <option value="gassupply">Gas Supply</option>
                        <option value="medicalsupply">Medical Supply</option>
                        <option value="foodsupply">Food Supply</option>
                    </select>
                </div>
                <div class="sortby">
                    <label for="sortby2">Sort By Status:</label>
                    <select id="sortby2" name="sortby2">
                        <option value="">All Status</option>
                        <option value="availablesupply">Available</option>
                        <option value="limitedsupply">Limited</option>
                        <option value="ofssupply">Out of Stock</option>
                    </select>
                </div>
            </div>
            <div class="tablecontainer" id="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Store Name</th>
                            <th>Address</th>
                            <th>Type of Supply</th>
                            <th>Working Hour</th>
                            <th>Contact Number</th>
                            <th>Supply Status</th>
                            <th>Edit Supply Status</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Dynamic rows will be appended here -->
                    </tbody>
                </table>

                <!-- Pagination inside the table container -->
                <div class="pagination" id="pagination-container">
                    <!-- Pagination buttons will be dynamically added here -->
                </div>
            </div>
            <div class="roadManipulation">
                <div class="reportedRoadClosure"></div>
                <div class="roadReopen"></div>
            </div>
        </div>
    </div>

    <script>
        const apiBaseUrl = 'http://localhost:5000'; 
        const rowsPerPage = 6; 
        let currentPage = 1;
        let filteredStores = [];

        // Fetch stores from the database and display them in the table
        async function fetchStores() {
            try {
                const response = await fetch(`${apiBaseUrl}/get-stores`);
                const stores = await response.json();

                if (Array.isArray(stores)) {
                    // Get selected filter values
                    const supplyTypeFilter = document.getElementById("sortby1").value;
                    const supplyStatusFilter = document.getElementById("sortby2").value;

                    // Filter stores based on selected options
                    filteredStores = stores.filter(store => {
                        const matchesSupplyType = supplyTypeFilter ? store.supplyType === supplyTypeFilter : true;
                        const matchesSupplyStatus = supplyStatusFilter ? store.supplyStatus === supplyStatusFilter : true;
                        return matchesSupplyType && matchesSupplyStatus;
                    });

                    displayStores();
                    updatePagination();
                } else {
                    console.error("Invalid response format:", stores);
                }
            } catch (error) {
                console.error("Error fetching stores:", error);
            }
        }

        // Display stores in the table
        function displayStores() {
            const tableBody = document.getElementById("table-body");
            tableBody.innerHTML = ''; // Clear previous rows

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(currentPage * rowsPerPage, filteredStores.length);

            for (let i = startIndex; i < endIndex; i++) {
                const store = filteredStores[i];
                const row = ` 
                    <tr>
                        <td>${store.name}</td>
                        <td>${store.address}</td>
                        <td>${store.supplyType}</td>
                        <td>${store.hours}</td>
                        <td>${store.contact}</td>
                        <td><span class="supply-status">${store.supplyStatus}</span></td>
                        <td><button class="edit-button">EDIT</button></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        }

        // Update pagination buttons based on the current page
        function updatePagination() {
            const totalPages = Math.ceil(filteredStores.length / rowsPerPage);
            const paginationContainer = document.getElementById("pagination-container");
            paginationContainer.innerHTML = ''; // Clear current pagination

            // Generate previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePage(-1);
            paginationContainer.appendChild(prevButton);

            // Generate page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerHTML = i;
                pageButton.classList.add('page-number');
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.onclick = () => goToPage(i);
                paginationContainer.appendChild(pageButton);
            }

            // Generate next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePage(1);
            paginationContainer.appendChild(nextButton);
        }

        // Handle pagination button click
        function changePage(direction) {
            currentPage += direction;
            displayStores();
            updatePagination();
        }

        // Go to a specific page when clicking on page number
        function goToPage(page) {
            currentPage = page;
            displayStores();
            updatePagination();
        }

        // Add event listeners for the dropdowns
        document.getElementById("sortby1").addEventListener("change", fetchStores);
        document.getElementById("sortby2").addEventListener("change", fetchStores);

        // Fetch and display stores on page load
        fetchStores();
    </script>
</body>
</html>
